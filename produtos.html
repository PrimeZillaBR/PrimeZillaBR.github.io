<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDlzVS8ZkI4bVAmcFyKH1PDojvTXGYXyso",
    authDomain: "primezilla-70b94.firebaseapp.com",
    projectId: "primezilla-70b94",
    storageBucket: "primezilla-70b94.firebasestorage.app",
    appId: "1:910803172382:web:db82186d77b8281f13020f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const PHONE = '5567992018672';

  function esc(s){ 
    return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); 
  }

  const grid = document.getElementById('productsGrid');
  const q = query(collection(db,'products'), orderBy('createdAt','desc'));

  let produtos = [];

  onSnapshot(q, snap => {
    produtos = [];
    snap.forEach(d => produtos.push(d.data()));
    render('all'); // mostra todos ao carregar
  });

  document.querySelectorAll('.catBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      render(btn.dataset.cat);
    });
  });

  function render(filter){
    grid.innerHTML = '';
    let count = 0;

    produtos.forEach(p=>{
      if(!p.active) return;
      if(filter!=='all' && p.category !== filter) return;

      const img = p.imageUrl || p.image || 'placeholder.png';
      const priceText = p.price ? `${p.currency||'R$'} ${Number(p.price).toFixed(2)}` : 'Consultar valores';

      const el = document.createElement('div');
      el.className = 'card';

      el.innerHTML = `
        <img src="${esc(img)}" alt="${esc(p.name)}">
        <h3>${esc(p.name)}</h3>
        <p class="price">${esc(priceText)}</p>
        <a class="botao buy">Comprar</a>
      `;

      el.querySelector('.buy').addEventListener('click', ()=> {
        const variantLabel = (p.type==='pod')? 'Sabor' : 'Cor';
        const variant = (p.options && p.options[0])? p.options[0] : '-';

        const text = encodeURIComponent(
          `Ol√°! Tenho interesse no produto: ${p.name}\nQuantidade: 1\n${variantLabel}: ${variant}\nValor: ${priceText}\nForma de Pagamento: PIX`
        );

        window.open(`https://wa.me/${PHONE}?text=${text}`,'_blank');
      });

      grid.appendChild(el);
      count++;
    });

    if(count === 0){
      grid.innerHTML = '<p>Nenhum item nesta categoria.</p>';
    }
  }
</script>
