<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlzVS8ZkI4bVAmcFyKH1PDojvTXGYXyso",
  authDomain: "primezilla-70b94.firebaseapp.com",
  projectId: "primezilla-70b94",
  storageBucket: "primezilla-70b94.firebasestorage.app",
  appId: "1:910803172382:web:db82186d77b8281f13020f"
};

const PHONE = '5567992018672';
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

const grid = document.getElementById('productsGrid');

// login anônimo para poder ler quando regras requerem auth (se você optar por exigir auth)
signInAnonymously(auth).catch(()=>{ /* ignora se falhar - leitura pública também funciona */ });

// Query: tenta ordenar por createdAt, mas se não existir, ainda retorna (no onSnapshot)
const q = query(collection(db, 'products'), orderBy('createdAt','desc'));
onSnapshot(q, snap => {
  const products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render(products, 'all');

  document.querySelectorAll('.catBtn').forEach(btn => {
    btn.onclick = () => render(products, btn.dataset.cat);
  });
}, err => {
  console.error(err);
  grid.innerHTML = '<p>Erro ao carregar produtos.</p>';
});

function normalizeCat(v){
  if(!v) return '';
  return v.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
}

function render(list, cat){
  grid.innerHTML = '';
  const wanted = normalizeCat(cat);

  list.forEach(p => {
    // garantia: normalize category from doc
    const pcat = normalizeCat(p.category);
    if(!p.active) return;
    if(wanted !== 'all' && pcat !== wanted) return;

    const img = p.imageUrl || p.image || 'placeholder.png';
    const priceText = p.price ? `${p.currency||'R$'} ${Number(p.price).toFixed(2)}` : 'Consultar valores';

    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <img src="${esc(img)}" alt="${esc(p.name)}">
      <h3>${esc(p.name)}</h3>
      <p class="price">${esc(priceText)}</p>
      <a class="botao buy">Comprar</a>
    `;
    el.querySelector('.buy').addEventListener('click', ()=>{
      const text = encodeURIComponent(`Olá! Tenho interesse no produto: ${p.name}\nQuantidade: 1\nValor: ${priceText}\nForma de Pagamento: PIX`);
      window.open(`https://wa.me/${PHONE}?text=${text}`,'_blank');
    });
    grid.appendChild(el);
  });

  if(grid.children.length === 0) grid.innerHTML = '<p>Nenhum item nesta categoria.</p>';
}
</script>
