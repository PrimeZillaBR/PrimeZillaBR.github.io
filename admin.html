<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — PrimeZilla</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .small{color:#9fb6c3;font-size:13px}
    .wrap{max-width:980px;margin:18px auto;padding:12px}
    #loginCard, #panel{background:linear-gradient(180deg,#071226,#041827);padding:18px;border-radius:12px;border:1px solid rgba(0,212,255,0.06)}
    input, select {padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#061427;color:#e6f7ff;width:100%;box-sizing:border-box}
    .botao{background:linear-gradient(90deg,#00d4ff,#007ac1);color:#001826;padding:10px;border-radius:8px;border:none;cursor:pointer}
    .muted{color:#9fb6c3}
    .prod-row{display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,0.03);padding:8px;margin-bottom:8px}
    .prod-row img{width:80px;height:80px;object-fit:cover;border-radius:6px}
    .right{margin-left:auto}
    .danger{background:#c0392b;color:white;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h2 class="muted">Painel Admin — PrimeZilla</h2>
    <div id="loginCard">
      <h3 class="muted">Login</h3>
      <p class="small">Use a conta de admin (Firebase Auth)</p>
      <label>Email</label>
      <input id="loginUser" placeholder="email">
      <label>Senha</label>
      <input id="loginPass" type="password" placeholder="senha">
      <label style="margin-top:8px">Cloudinary unsigned upload preset</label>
      <input id="cloudinaryPreset" placeholder="ex: produtos_preset (já configurado)">
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="btnLogin" class="botao">Entrar</button>
      </div>
      <p class="small" style="margin-top:8px">OBS: este painel grava direto no Firestore. A imagem será enviada ao Cloudinary.</p>
    </div>

    <div id="panel" style="margin-top:14px;display:none">
      <div style="display:flex;gap:12px;align-items:center">
        <div><strong id="who"></strong></div>
        <div style="margin-left:auto">
          <button id="refreshList" class="botao">Recarregar lista</button>
          <button id="logoutBtn" class="botao" style="background:#c0392b">Logout</button>
        </div>
      </div>

      <hr style="margin:12px 0">
      <h3 class="muted">Adicionar produto</h3>
      <form id="addForm">
        <label>Nome</label>
        <input id="p_name" required>
        <label style="margin-top:8px">Preço (apenas números)</label>
        <input id="p_price" placeholder="39.90">
        <label style="margin-top:8px">Categoria</label>
        <select id="p_cat">
          <option value="pods">Pods</option>
          <option value="acessorios">Acessórios</option>
          <option value="eletronicos">Eletrônicos</option>
          <option value="outros">Outros</option>
        </select>

        <label style="margin-top:8px">Tipo</label>
        <select id="p_type">
          <option value="pod">Pod (usar sabores)</option>
          <option value="non-pod">Não-pod (usar cores)</option>
        </select>

        <label style="margin-top:8px">Opções (separadas por vírgula)</label>
        <input id="p_opts" placeholder="Ex: Peach Mango, Menthol, Watermelon">

        <label style="margin-top:8px">Imagem</label>
        <input id="p_image" type="file" accept="image/*">

        <label style="margin-top:8px"><input id="p_active" type="checkbox" checked> Ativo</label>

        <div style="margin-top:10px">
          <button class="botao" id="publishBtn">Publicar produto</button>
        </div>
      </form>

      <hr style="margin:12px 0">
      <h3 class="muted">Produtos cadastrados</h3>
      <div id="list"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* CONFIG FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDlzVS8ZkI4bVAmcFyKH1PDojvTXGYXyso",
  authDomain: "primezilla-70b94.firebaseapp.com",
  projectId: "primezilla-70b94",
  storageBucket: "primezilla-70b94.firebasestorage.app",
  appId: "1:910803172382:web:db82186d77b8281f13020f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const CLOUD_NAME = 'duwsueept';
let UPLOAD_PRESET = '';

const el = id => document.getElementById(id);

/* LOGIN */
el('btnLogin').addEventListener('click', async ()=>{
  const email = el('loginUser').value.trim();
  const pass = el('loginPass').value;
  UPLOAD_PRESET = el('cloudinaryPreset').value.trim();

  if(!email || !pass) return alert('Preencha email e senha');
  try{
    await signInWithEmailAndPassword(auth, email, pass);
  }catch(err){
    alert('Erro de login: ' + err.message);
  }
});

/* LOGOUT */
el('logoutBtn').addEventListener('click', async ()=>{
  await signOut(auth);
  location.reload();
});

/* STATUS LOGIN */
onAuthStateChanged(auth, user=>{
  if(user){
    el('loginCard').style.display = 'none';
    el('panel').style.display = '';
    el('who').textContent = user.email;
    loadList();
  } else {
    el('loginCard').style.display = '';
    el('panel').style.display = 'none';
  }
});

/* UPLOAD CLOUDINARY */
async function uploadToCloudinary(file){
  if(!file) return '';
  if(!UPLOAD_PRESET) throw new Error('Preencha o preset do Cloudinary no campo acima');

  const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);

  const res = await fetch(url, { method: 'POST', body: fd });
  if(!res.ok) throw new Error('Falha upload Cloudinary');

  const j = await res.json();
  return j.secure_url;
}

/* LISTAR */
async function loadList(){
  const list = el('list');
  list.innerHTML = 'Carregando...';

  const snap = await getDocs(collection(db,'products'));
  const arr = [];
  snap.forEach(d => arr.push({id:d.id, ...d.data()}));

  list.innerHTML = '';
  if(!arr.length){
    list.innerHTML = '<p class="small">Nenhum produto publicado.</p>';
    return;
  }

  arr.forEach(p=>{
    const row = document.createElement('div');
    row.className='prod-row';

    row.innerHTML = `
      <img src="${p.imageUrl}">
      <div>
        <strong>${p.name}</strong><br>
        <span class="small">${p.category} • ${p.type}</span>
      </div>
      <div class="right">
        <button class="danger" onclick="window.deleteProd('${p.id}')">Excluir</button>
      </div>
    `;

    list.appendChild(row);
  });
}

/* EXCLUIR */
window.deleteProd = async (id)=>{
  if(!confirm('Excluir produto?')) return;
  await deleteDoc(doc(db,'products',id));
  loadList();
}

/* PUBLICAR */
el('publishBtn').addEventListener('click', async (e)=>{
  e.preventDefault();

  try{
    const name = el('p_name').value.trim();
    if(!name) return alert('Preencha nome');

    const price = el('p_price').value || null;
    const category = el('p_cat').value;
    const type = el('p_type').value;
    const options = el('p_opts').value.trim()
      ? el('p_opts').value.split(',').map(v=>v.trim())
      : [];
    const file = el('p_image').files[0];
    const active = el('p_active').checked;

    el('publishBtn').disabled = true;
    el('publishBtn').textContent = 'Publicando...';

    let imageUrl = '';
    if(file) imageUrl = await uploadToCloudinary(file);

    await addDoc(collection(db,'products'),{
      name,
      price: price?Number(price):null,
      category,
      type,
      options,
      imageUrl,
      active,
      createdAt: serverTimestamp()
    });

    alert('Produto publicado com sucesso!');
    el('addForm').reset();
    loadList();
  }catch(err){
    alert('Erro ao publicar: ' + err.message);
  }finally{
    el('publishBtn').disabled = false;
    el('publishBtn').textContent = 'Publicar produto';
  }
});

el('refreshList').addEventListener('click', loadList);
</script>

</body>
</html>
